import { useState, useEffect } from 'react';
import Mapa from '../components/Mapa';
import './Admin.css';

function Admin() {
  const [tipo, setTipo] = useState('');
  const [usuarios, setUsuarios] = useState([]);
  const [nuevoUser, setNuevoUser] = useState('');
  const [nuevoPass, setNuevoPass] = useState('');
  const [nuevoRol, setNuevoRol] = useState('6');
  const [loading, setLoading] = useState(false);

  // Cargar usuarios
  useEffect(() => {
    cargarUsuarios();
  }, []);

  const cargarUsuarios = async () => {
    try {
      const response = await fetch('http://localhost:3000/api/usuarios');
      const data = await response.json();
      setUsuarios(data.data || []);
    } catch (err) {
      console.error('Error:', err);
    }
  };

  // Crear usuario
  const agregarUsuario = async () => {
    if (!nuevoUser || !nuevoPass) return;

    try {
      setLoading(true);
      const response = await fetch('http://localhost:3000/api/usuarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre: nuevoUser,
          correo: nuevoUser + '@universidad.edu',
          password: nuevoPass,
          id_rol: parseInt(nuevoRol)
        })
      });

      if (response.ok) {
        setNuevoUser('');
        setNuevoPass('');
        setNuevoRol('6');
        cargarUsuarios();
        alert('Usuario creado');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  // Eliminar usuario
  const eliminarUsuario = async (id) => {
    if (!window.confirm('¿Eliminar?')) return;

    try {
      await fetch(`http://localhost:3000/api/usuarios/${id}`, {
        method: 'DELETE'
      });
      cargarUsuarios();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  };

  return (
    <div className="app-container">
      <h2>Administrador</h2>

      <div className="card">
        <h3>Seleccionar tipo de contenedor</h3>
        <select value={tipo} onChange={e => setTipo(e.target.value)}>
          <option value="">Seleccione</option>
          <option value="amarillo">Amarillo</option>
          <option value="azul">Azul</option>
          <option value="verde">Verde</option>
        </select>
        <p>Click en el mapa para colocar el contenedor</p>
      </div>

      <Mapa rol="admin" tipoSeleccionado={tipo} />

      <div className="card">
        <h3>Gestión de usuarios ({usuarios.length})</h3>

        <input
          placeholder="Usuario"
          value={nuevoUser}
          onChange={e => setNuevoUser(e.target.value)}
          className="input"
        />

        <input
          placeholder="Contraseña"
          type="password"
          value={nuevoPass}
          onChange={e => setNuevoPass(e.target.value)}
          className="input"
        />

        <select value={nuevoRol} onChange={e => setNuevoRol(e.target.value)} className="input">
          <option value="6">Usuario</option>
          <option value="7">Limpieza</option>
          <option value="5">Admin</option>
        </select>

        <button onClick={agregarUsuario} disabled={loading} className="btn btn-primary">
          {loading ? 'Creando...' : 'Agregar'}
        </button>

        <ul className="usuarios-list">
          {usuarios.map(u => (
            <li key={u.id_usuario}>
              <div>
                <strong>{u.nombre}</strong>
                <br />
                <small>{u.correo} • {u.rol}</small>
              </div>
              <button onClick={() => eliminarUsuario(u.id_usuario)} className="btn btn-danger">
                Eliminar
              </button>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
export default Admin;
